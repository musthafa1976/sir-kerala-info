<!DOCTYPE html>
<html lang="ml">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIR Kerala 2025</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root { --primary: #1a237e; --success: #2e7d32; --danger: #c62828; --warning: #ff8f00; --nri: #1976d2; }
    body { background: linear-gradient(135deg, #e8f5e8, #e3f2fd); min-height: 100vh; font-family: 'Noto Sans Malayalam', sans-serif; color: #333; }
    .card { border: none; border-radius: 20px; box-shadow: 0 12px 35px rgba(0,0,0,0.15); overflow: hidden; }
    .card-header { background: linear-gradient(135deg, var(--primary), #3949ab); color: white; font-weight: 700; text-align: center; padding: 1.5rem; font-size: 1.4rem; }
    .btn-choice { min-height: 140px; font-size: 1.3rem; font-weight: 600; border-radius: 18px; transition: all 0.4s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 8px; }
    .btn-choice i { font-size: 2.5rem; }
    .btn-resident { background: #e8f5e8; color: var(--success); border: 3px solid #4caf50; }
    .btn-nri { background: #e3f2fd; color: var(--nri); border: 3px solid #1976d2; }
    .btn-choice:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
    .question-card { margin: 25px 0; animation: fadeIn 0.6s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .btn-answer { min-width: 130px; padding: 14px; font-weight: 600; border-radius: 14px; font-size: 1.1rem; }
    .btn-yes { background: #4caf50; color: white; }
    .btn-no { background: #f44336; color: white; }
    .progress { height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin: 25px 0; }
    .progress-bar { background: linear-gradient(90deg, #4caf50, #8bc34a); transition: width 0.7s ease; }
    .result-card { background: linear-gradient(135deg, #e8f5e8, #f1f8e9); border: 3px solid #4caf50; border-radius: 20px; padding: 30px; margin-top: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .docs-list { background: white; padding: 18px; border-radius: 14px; margin: 18px 0; border-left: 6px solid #4caf50; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .doc-item { padding: 10px 0; border-bottom: 1px dashed #ddd; display: flex; align-items: flex-start; gap: 10px; }
    .doc-item i { color: var(--success); margin-top: 3px; }
    .doc-item:last-child { border-bottom: none; }
    .nri-badge { background: var(--nri); color: white; padding: 6px 14px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; }
    .footer { text-align: center; padding: 25px; background: #f5f5f5; color: #555; font-size: 15px; margin-top: 60px; border-top: 1px solid #ddd; }
    .back-home { display: inline-flex; align-items: center; gap: 8px; color: var(--primary); text-decoration: none; font-weight: 600; }
    @media print { .no-print { display: none; } body { background: white; } }
  </style>
</head>
<body>

<div class="container my-5">
  <div class="card">
    <div class="card-header">
      <h3>SIR Kerala 2025</h3>
      <small class="d-block mt-1">നിങ്ങളുടെ വോട്ടർ സ്ഥാനം | ECI ഗൈഡ്‌ലൈൻസ്</small>
    </div>
    <div class="card-body p-4">

      <!-- HOME -->
      <div id="homePage">
        <h5 class="text-center mb-4 fw-bold">നിങ്ങൾ ആരാണ്?</h5>
        <div class="row g-4">
          <div class="col-12 col-md-6">
            <button class="btn btn-choice btn-resident w-100" onclick="startFlow(false)">
              <i class="bi bi-house-door-fill"></i>
              <div><strong>Resident</strong></div>
              <small>കേരളത്തിൽ താമസിക്കുന്നു</small>
            </button>
          </div>
          <div class="col-12 col-md-6">
            <button class="btn btn-choice btn-nri w-100" onclick="startFlow(true)">
              <i class="bi bi-globe2"></i>
              <div><strong>NRI</strong></div>
              <small>വിദേശത്ത് താമസം</small>
            </button>
          </div>
        </div>
        <div class="text-center mt-4">
          <small class="text-muted">Timeline: Nov 4 – Dec 4, 2025 | Helpline: 1950</small>
        </div>
      </div>

      <!-- Questions -->
      <div id="questions" class="d-none">
        <div class="progress">
          <div class="progress-bar" id="progress" style="width: 33%"></div>
        </div>

        <!-- Q1 -->
        <div class="question-card" id="q1">
          <div class="card border-primary">
            <div class="card-body text-center">
              <h5>Q1. 2002 വോട്ടർ പട്ടികയിൽ നിങ്ങളുടെ പേര് ഉണ്ടോ?</h5>
              <div class="d-flex justify-content-center gap-3 mt-4">
                <button class="btn btn-answer btn-yes" onclick="answerQ1(true)">അതെ</button>
                <button class="btn btn-answer btn-no" onclick="answerQ1(false)">ഇല്ല</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Q2 -->
        <div class="question-card d-none" id="q2">
          <div class="card border-warning">
            <div class="card-body text-center">
              <h5>Q2. നിങ്ങളുടെ മാതാപിതാക്കളുടെ പേര് 2002-ൽ ഉണ്ടോ?</h5>
              <div class="d-flex justify-content-center gap-3 mt-4">
                <button class="btn btn-answer btn-yes" onclick="showResult('1B')">അതെ</button>
                <button class="btn btn-answer btn-no" onclick="showQuestion('q3')">ഇല്ല</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Q3 -->
        <div class="question-card d-none" id="q3">
          <div class="card border-info">
            <div class="card-body text-center">
              <h5>Q3. നിങ്ങളുടെ ജനനം ഏത് കാലയളവിൽ?</h5>
              <div class="mt-4">
                <div class="form-check text-start mb-2">
                  <input class="form-check-input" type="radio" name="dob" value="A" id="pre87">
                  <label class="form-check-label fw-bold" for="pre87">1987 ജൂലൈ 1-ന് മുമ്പ്</label>
                </div>
                <div class="form-check text-start mb-2">
                  <input class="form-check-input" type="radio" name="dob" value="B" id="mid">
                  <label class="form-check-label fw-bold" for="mid">1987 ജൂലൈ 1 മുതൽ 2004 ഡിസംബർ 3 വരെ</label>
                </div>
                <div class="form-check text-start mb-3">
                  <input class="form-check-input" type="radio" name="dob" value="C" id="post">
                  <label class="form-check-label fw-bold" for="post">2004 ഡിസംബർ 4-ന് ശേഷം</label>
                </div>
              </div>
              <button class="btn btn-primary btn-lg mt-3" onclick="submitDOB()">തുടരുക</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Result -->
      <div id="result" class="d-none">
        <div class="result-card" id="resultCard">
          <div class="text-center mb-3">
            <span class="nri-badge" id="nriBadge" style="display:none">NRI</span>
          </div>
          <h4 class="text-success text-center">നിങ്ങളുടെ ഫലം</h4>
          <div id="scenarioInfo" class="mt-3 fw-bold fs-5"></div>
          <div class="docs-list" id="docs"></div>
          <div class="mt-4">
            <p class="mb-2"><strong>ഫോം:</strong> <span id="form" class="text-primary fw-bold"></span></p>
            <p class="mb-2"><strong>നടപടി:</strong> <span id="action"></span></p>
            <p class="mb-2"><strong>ലീഗൽ ടിപ്പ്:</strong> <span id="tip"></span></p>
          </div>

          <!-- Share Buttons -->
          <div class="text-center mt-4 no-print">
            <button class="btn btn-success btn-lg me-2" data-bs-toggle="modal" data-bs-target="#nameModal" onclick="preparePDF('whatsapp')">
              WhatsApp (PDF)
            </button>
            <button class="btn btn-outline-success btn-lg me-2" data-bs-toggle="modal" data-bs-target="#nameModal" onclick="preparePDF('print')">
              Print / PDF
            </button>
            <a href="#" class="back-home" onclick="resetAll()">
              Home
            </a>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Name Modal -->
<div class="modal fade" id="nameModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">നിങ്ങളുടെ പേര് നൽകൂ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="modalNameInput" class="form-control form-control-lg text-center" placeholder="ഉദാ: രാജേഷ് കുമാർ" />
        <small class="text-muted d-block text-center mt-2">PDF-ൽ ഉപയോഗിക്കും (ഓപ്ഷണൽ)</small>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ക്യാൻസൽ</button>
        <button type="button" class="btn btn-primary" onclick="generatePDFWithName()">OK</button>
      </div>
    </div>
  </div>
</div>

<footer class="footer no-print">
  <p>Developed by <strong>AMS</strong> with <strong>Grok</strong> | 
  <a href="https://ceokerala.nic.in/sir" target="_blank" style="color: var(--primary);">CEO Kerala</a> | 
  Helpline: <strong>1950</strong></p>
</footer>

<script>
  let isNRI = false;
  let currentStep = 0;
  let pdfAction = ''; // 'whatsapp' or 'print'

  const scenarios = {
    '1A': { title: "Case #1A: Self in 2002 List", qualifies: "നിങ്ങളുടെ പേര് 2002-ൽ ഉണ്ട്", docs: ["2002 extract", "നിലവിലെ ഐഡന്റിറ്റി"], form: "Auto / Form-8", action: "BLO-യ്ക്ക് extract കാണിക്കുക", tip: "ECI Order 23/2025" },
    '1B': { title: "Case #1B: Child of 2002 Voter", qualifies: "മാതാപിതാക്കളുടെ പേര് 2002-ൽ", docs: ["Parents' extract", "ജനന സർട്ടിഫിക്കറ്റ്"], form: "Form-8", action: "extract + ജനനം", tip: "ECI relaxation" },
    2: { title: "Case #2: Pre-1987", docs: ["ജനന സർട്ടിഫിക്കറ്റ്"], form: "Form-8", action: "ഒരു രേഖ മതി", tip: "1955 Act" },
    3: { title: "Case #3: 1987–2004", docs: ["Own + ഒരു Parent"], form: "Form-8", action: "ഒരു മാതാപിതാവ് ഇന്ത്യൻ", tip: "1986 Amendment" },
    4: { title: "Case #4: Post-2004", docs: ["Own + Both Parents"], form: "Form-6", action: "Full verification", tip: "2004 Amendment" }
  };

  function startFlow(nri) {
    isNRI = nri;
    document.getElementById('homePage').classList.add('d-none');
    document.getElementById('questions').classList.remove('d-none');
    if (isNRI) document.getElementById('nriBadge').style.display = 'inline-block';
    showQuestion('q1');
  }

  function showQuestion(id) {
    currentStep++;
    const percent = currentStep <= 3 ? currentStep * 33 : 100;
    document.getElementById('progress').style.width = percent + '%';
    document.getElementById(id).classList.remove('d-none');
  }

  function answerQ1(yes) {
    document.getElementById('q1').classList.add('d-none');
    if (yes) showResult('1A');
    else showQuestion('q2');
  }

  function submitDOB() {
    const selected = document.querySelector('input[name="dob"]:checked');
    if (!selected) return alert("ദയവായി ഒരു ഓപ്ഷൻ തിരഞ്ഞെടുക്കുക");
    document.getElementById('q3').classList.add('d-none');
    const num = selected.value === 'A' ? 2 : selected.value === 'B' ? 3 : 4;
    showResult(num);
  }

  function showResult(key) {
    const s = scenarios[key];
    const nriExtra = isNRI ? "<br><strong>NRI:</strong> Video verification allowed" : "";

    document.getElementById('scenarioInfo').innerHTML = `
      <div class="text-center">
        <strong class="text-success fs-4">${key === '1A' ? 'Case #1A' : key === '1B' ? 'Case #1B' : 'Case #' + key}</strong><br>
        <span class="fs-5">${s.title}</span>
      </div>
      <p class="mt-2 text-muted"><em>${s.qualifies}</em></p>
    `;

    let docsHTML = '<strong>ആവശ്യമായ രേഖകൾ:</strong><ul class="mt-3">';
    s.docs.forEach(d => docsHTML += `<li class="doc-item"><i class="bi bi-check-circle-fill"></i> ${d}</li>`);
    docsHTML += '</ul>';
    document.getElementById('docs').innerHTML = docsHTML;

    document.getElementById('form').textContent = s.form;
    document.getElementById('action').textContent = s.action;
    document.getElementById('tip').innerHTML = s.tip + nriExtra;

    document.getElementById('questions').classList.add('d-none');
    document.getElementById('result').classList.remove('d-none');
  }

  function resetAll() { location.reload(); }

  // Prepare PDF action
  function preparePDF(action) {
    pdfAction = action;
  }

  // Generate PDF with Name
  async function generatePDFWithName() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('nameModal'));
    modal.hide();

    let userName = document.getElementById('modalNameInput').value.trim() || "നിങ്ങളുടെ പേര്";
    const card = document.getElementById('resultCard');

    try {
      const canvas = await html2canvas(card, { scale: 2 });
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const imgWidth = 190;
      const pageHeight = 277;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;
      let position = 20;

      // Add Name at top
      pdf.setFontSize(18);
      pdf.text(`${userName} - SIR Result`, 105, 15, { align: 'center' });

      pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft >= 0) {
        position = heightLeft - imgHeight + 20;
        pdf.addPage();
        pdf.setFontSize(18);
        pdf.text(`${userName} - SIR Result`, 105, 15, { align: 'center' });
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      const pdfBlob = pdf.output('blob');
      const safeName = userName.replace(/[^a-zA-Z0-9]/g, '_');
      const file = new File([pdfBlob], `${safeName}_SIR_Result.pdf`, { type: 'application/pdf' });

      if (pdfAction === 'whatsapp') {
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: 'SIR Kerala Result',
            text: `എന്റെ SIR ഫലം: ${userName}`
          });
        } else {
          const url = URL.createObjectURL(pdfBlob);
          window.open(`https://wa.me/?text=${encodeURIComponent(userName + ' - SIR Result')}&attachment=${url}`, '_blank');
        }
      } else {
        // Print or Save
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${safeName}_SIR_Result.pdf`;
        a.click();
      }
    } catch (err) {
      alert("PDF generation failed.");
      console.error(err);
    }
  }
</script>

<!-- Bootstrap JS for Modal -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>
